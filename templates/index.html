<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ app_name }}</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header>
      <h1>{{ app_name }}</h1>
    </header>
    <main>
      <section>
        <p>Welcome! Connect your Hevy data and view your workout dashboard.</p>
        <ul>
          <li><a href="/healthz">Health check</a></li>
        </ul>
        <form method="post" action="/sync-now" style="margin-top:12px;">
          <button type="submit">Sync now</button>
        </form>
        <form method="post" action="/sync-all" style="margin-top:8px;">
          <button type="submit">Backfill all</button>
        </form>
        <form method="post" action="/reset-db" style="margin-top:8px;">
          <button type="submit" style="background:#8b2c2c;color:#fff;">Reset & Re-sync</button>
        </form>
        {% if request.query_params.get('synced') %}
        <p style="margin-top:8px; color:#8ab4f8;">Synced {{ request.query_params.get('synced') }} new workouts.</p>
        {% elif request.query_params.get('backfilled') %}
        <p style="margin-top:8px; color:#8ab4f8;">Backfilled {{ request.query_params.get('backfilled') }} workouts.</p>
        {% elif request.query_params.get('error') == 'sync' %}
        <p style="margin-top:8px; color:#f28482;">Sync failed. Please try again.</p>
        {% elif request.query_params.get('reset') %}
        <p style="margin-top:8px; color:#8ab4f8;">Database reset! Click "Backfill all" to re-sync your workouts.</p>
        {% elif request.query_params.get('error') == 'backfill' %}
        <p style="margin-top:8px; color:#f28482;">Backfill failed. Please try again.</p>
        {% elif request.query_params.get('error') == 'reset' %}
        <p style="margin-top:8px; color:#f28482;">Reset failed. Please try again.</p>
        {% endif %}
      </section>
      <section style="margin-top:16px;">
        <h2 style="margin-top:0; font-size:18px;">Stats</h2>
        <div id="statsCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-top:12px;"></div>
      </section>
      <section style="margin-top:16px;">
        <h2 id="heatmapTitle" style="margin-top:0; font-size:18px;">Workout activity (past year)</h2>
        <div id="heatmap" style="overflow-x:auto;"></div>
      </section>
      <section style="margin-top:16px;">
        <h2 style="margin-top:0; font-size:18px;">Top exercises</h2>
        <div id="topExercises"></div>
      </section>
    </main>
    <script>
      async function loadHeatmap() {
        const res = await fetch('/api/heatmap-year');
        const json = await res.json();
        const container = document.getElementById('heatmap');
        if (!container) return;

        const days = json.days;
        const startDate = new Date(json.start_date);
        
        // Update title with total count
        const totalWorkouts = days.reduce((sum, d) => sum + d.count, 0);
        document.getElementById('heatmapTitle').textContent = `${totalWorkouts} workout${totalWorkouts !== 1 ? 's' : ''} in the last year`;
        
        // Group days by week
        const weeks = [];
        let currentWeek = [];
        const startDay = startDate.getDay(); // 0 = Sunday
        
        // Add empty cells for days before start
        for (let i = 0; i < startDay; i++) {
          currentWeek.push(null);
        }
        
        days.forEach((day, idx) => {
          currentWeek.push(day);
          if (currentWeek.length === 7) {
            weeks.push(currentWeek);
            currentWeek = [];
          }
        });
        
        if (currentWeek.length > 0) {
          while (currentWeek.length < 7) currentWeek.push(null);
          weeks.push(currentWeek);
        }

        // Render heatmap
        const maxCount = Math.max(...days.map(d => d.count));
        const getColor = (count) => {
          if (count === 0) return '#0d1117';
          const intensity = Math.min(count / Math.max(maxCount, 1), 1);
          if (intensity < 0.25) return '#0e4429';
          if (intensity < 0.5) return '#006d32';
          if (intensity < 0.75) return '#26a641';
          return '#39d353';
        };

        // Build month labels
        const monthLabels = [];
        let lastMonth = -1;
        weeks.forEach((week, weekIdx) => {
          const firstDay = week.find(d => d !== null);
          if (firstDay) {
            const date = new Date(firstDay.date);
            const month = date.getMonth();
            if (month !== lastMonth) {
              monthLabels.push({ weekIdx, month: date.toLocaleString('default', { month: 'short' }) });
              lastMonth = month;
            }
          }
        });

        let html = '<div style="display:flex;gap:3px;font-size:10px;color:#8b949e;">';
        html += '<div style="display:flex;flex-direction:column;gap:3px;margin-right:4px;padding-top:15px;">';
        ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach((day, i) => {
          if (i % 2 === 1) html += `<div style="height:11px;line-height:11px;">${day}</div>`;
          else html += '<div style="height:11px;"></div>';
        });
        html += '</div>';
        html += '<div style="display:flex;flex-direction:column;">';
        html += '<div style="display:flex;gap:3px;margin-bottom:3px;height:12px;">';
        weeks.forEach((week, idx) => {
          const label = monthLabels.find(m => m.weekIdx === idx);
          html += `<div style="width:11px;text-align:left;">${label ? label.month : ''}</div>`;
        });
        html += '</div>';
        html += '<div style="display:flex;gap:3px;">';
        
        weeks.forEach(week => {
          html += '<div style="display:flex;flex-direction:column;gap:3px;">';
          week.forEach(day => {
            if (day === null) {
              html += '<div style="width:11px;height:11px;"></div>';
            } else {
              const color = getColor(day.count);
              const title = `${day.date}: ${day.count} workout${day.count !== 1 ? 's' : ''}`;
              html += `<div style="width:11px;height:11px;background:${color};border-radius:2px;" title="${title}"></div>`;
            }
          });
          html += '</div>';
        });
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        container.innerHTML = html;
      }
      
      async function loadStats() {
        const res = await fetch('/api/summary');
        const json = await res.json();
        const container = document.getElementById('statsCards');
        if (!container) return;
        
        const cards = [
          { label: 'Total Workouts', value: json.total_workouts, icon: '💪' },
          { label: 'Unique Exercises', value: json.total_exercises, icon: '🏋️' },
          { label: 'Total Sets', value: json.total_sets.toLocaleString(), icon: '📊' },
          { label: 'Total Volume', value: `${json.total_volume.toLocaleString()} lbs`, icon: '⚡' },
          { label: 'Active Weeks', value: `${json.weeks_current} weeks`, icon: '🔥' },
          { label: 'Longest Streak', value: `${json.weeks_longest} weeks`, icon: '📅' },
        ];
        
        let html = '';
        cards.forEach(card => {
          html += `<div style="background:#0f152b;padding:16px;border:1px solid #1e2a4a;border-radius:8px;">
            <div style="font-size:24px;margin-bottom:4px;">${card.icon}</div>
            <div style="font-size:20px;font-weight:600;color:#e6e6e6;margin-bottom:4px;">${card.value}</div>
            <div style="font-size:12px;color:#8b949e;">${card.label}</div>
          </div>`;
        });
        
        container.innerHTML = html;
      }
      
      async function loadTopExercises() {
        const res = await fetch('/api/top-exercises?limit=10');
        const json = await res.json();
        const container = document.getElementById('topExercises');
        if (!container) return;
        
        if (!json.exercises || json.exercises.length === 0) {
          container.innerHTML = '<p style="color:#8b949e;margin-top:8px;">No exercise data available yet. Try backfilling your workouts!</p>';
          return;
        }
        
        const maxCount = json.exercises[0].count;
        let html = '<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">';
        json.exercises.forEach((ex, idx) => {
          const barWidth = (ex.count / maxCount) * 100;
          html += `<div style="background:#0f152b;padding:12px;border:1px solid #1e2a4a;border-radius:6px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
              <span style="font-size:14px;color:#e6e6e6;">${ex.name}</span>
              <span style="font-size:12px;color:#8b949e;">${ex.count} workouts</span>
            </div>
            <div style="width:100%;height:6px;background:#1e2a4a;border-radius:3px;overflow:hidden;">
              <div style="width:${barWidth}%;height:100%;background:#8ab4f8;border-radius:3px;"></div>
            </div>
          </div>`;
        });
        html += '</div>';
        
        container.innerHTML = html;
      }
      
      loadStats();
      loadHeatmap();
      loadTopExercises();
    </script>
  </body>
</html>
